# Key Concepts

### NTFS (New Technology File System)

NTFS  is a file system developed by Microsoft as a part of its Windows NT operating system family. It was introduced with the release of Windows NT 3.1 in 1993, and it has since become the default and most widely used file system in modern Windows operating systems, including Windows XP, Windows 7, Windows 8, Windows 10, and their server counterparts.

NTFS was designed to address several limitations of its predecessor, the FAT (File Allocation Table) file system.

Here are some of the key forensic artifacts that digital investigators often analyze when working with NTFS file systems:


-    File Metadata: NTFS stores extensive metadata for each file, including creation time, modification time, access time, and attribute information (such as read-only, hidden, or system file attributes). Analyzing these timestamps can help establish timelines and reconstruct user activities.
-    MFT Entries: The Master File Table (MFT) is a crucial component of NTFS that stores metadata for all files and directories on a volume. Examining MFT entries provides insights into file names, sizes, timestamps, and data storage locations. When files are deleted, their MFT entries are marked as available, but the data may remain on the disk until overwritten.
-    File Slack and Unallocated Space: Unallocated space on an NTFS volume may contain remnants of deleted files or fragments of data. File slack refers to the unused portion of a cluster that may contain data from a previous file. Digital forensic tools can help recover and analyze data from these areas.
-    File Signatures: File headers and signatures can be useful in identifying file types even when file extensions have been changed or obscured. This information is critical for reconstructing the types of files present on a system.
-    USN Journal: The Update Sequence Number (USN) Journal is a log maintained by NTFS to record changes made to files and directories. Forensic investigators can analyze the USN Journal to track file modifications, deletions, and renames.
-    LNK Files: Windows shortcut files (LNK files) contain information about the target file or program, as well as timestamps and metadata. These files can provide insights into recently accessed files or executed programs.
-    Prefetch Files: Prefetch files are generated by Windows to improve the startup performance of applications. These files can indicate which programs have been run on the system and when they were last executed.
-    Registry Hives: While not directly related to the file system, Windows Registry hives contain important configuration and system information. Malicious activities or unauthorized changes can leave traces in the registry, which forensic investigators analyze to understand system modifications.
-    Shellbags: Shellbags are registry entries that store folder view settings, such as window positions and sorting preferences. Analyzing shellbags can reveal user navigation patterns and potentially identify accessed folders.
-    Thumbnail Cache: Thumbnail caches store miniature previews of images and documents. These caches can reveal files that were recently viewed, even if the original files have been deleted.
-    Recycle Bin: The Recycle Bin contains files that have been deleted from the file system. Analyzing the Recycle Bin can help recover deleted files and provide insights into user actions.
-    Alternate Data Streams (ADS): ADS are additional streams of data associated with files. Malicious actors may use ADS to hide data, and forensic investigators need to examine these streams to ensure a comprehensive analysis.
-    Volume Shadow Copies: NTFS supports Volume Shadow Copies, which are snapshots of the file system at different points in time. These copies can be valuable for data recovery and analysis of changes made over time.
-    Security Descriptors and ACLs: Access Control Lists (ACLs) and security descriptors determine file and folder permissions. Analyzing these artifacts helps understand user access rights and potential security breaches.

### MFT Structure ( Master File Table)

- File Record Header: Contains metadata about the file record itself. Includes fields like signature, sequence number, and other administrative data.

- Standard Information Attribute Header: Stores standard file metadata such as timestamps, file attributes, and security identifiers.

- File Name Attribute Header: Contains information about the filename, including its length, namespace, and Unicode characters.

- Data Attribute Header: Describes the file data attribute, which can be either resident (stored within the MFT record) or non-resident (stored in external clusters).

- File Data (File content): This section holds the actual file data, which can be the file's content or references to non-resident data clusters. For small files (less than 512 bytes), the data might be stored within the MFT record (resident). For larger files, it references non-resident data clusters on the disk. We'll see an example of this later on.

- Additional Attributes (optional): NTFS supports various additional attributes, such as security descriptors (SD), object IDs (OID), volume name (VOLNAME), index information, and more.

#### File Record Header


- Signature: A four-byte signature, usually "FILE" or "BAAD," indicating whether the record is in use or has been deallocated.
    
- Offset to Update Sequence Array: An offset to the Update Sequence Array (USA) that helps maintain the integrity of the record during updates.

- Size of Update Sequence Array: The size of the Update Sequence Array in words.
    
- Log File Sequence Number: A number that identifies the last update to the file record.

- Sequence Number: A number identifying the file record. The MFT records are numbered sequentially, starting from 0.

- Hard Link Count: The number of hard links to the file. This indicates how many directory entries point to this file record.

- Offset to First Attribute: An offset to the first attribute in the file record.


#### Attributes

|Type |	Attribute 	|Description|
|------|------|----|
|0x10 (16) |	$STANDARD_INFORMATION |	General information - flags, MAC times, owner, and security id.|
|0x20 (32) 	|$ATTRIBUTE_LIST |	Pointers to other attributes and a list of nonresident attributes.|
|0x30 (48) 	|$FILE_NAME |	File name - (Unicode) and outdated MAC times|
|0x40 (64) |	$VOLUME_VERSION |	Volume information - NTFS v1.2 only and Windows NT, no longer used|
|0x40 (64) |	$OBJECT_ID |	16B unique identifier - for file or directory (NTFS 3.0+; Windows 2000+)|
|0x50 (80) |	$SECURITY_DESCRIPTOR |	File's access control list and security properties|
|0x60 (96) |	$VOLUME_NAME |	Volume name|
|0x70 (112) |	$VOLUME_INFORMATION |	File system version and other information|
|0x80 (128) |	$DATA |	File contents|
|0x90 (144) |	$INDEX_ROOT |	Root node of an index tree|
|0xA0 (160) |	$INDEX_ALLOCATION |	Nodes of an index tree - with a root in $INDEX_ROOT|
|0xB0 (176) |	$BITMAP |	Bitmap - for the $MFT file and for indexes (directories)|
|0xC0 (192) |	$SYMBOLIC_LINK |	Soft link information - (NTFS v1.2 only and Windows NT)|
|0xC0 (192) |	$REPARSE_POINT |	Data about a reparse point - used for a soft link (NTFS 3.0+; Windows 2000+)|
|0xD0 (208) |	$EA_INFORMATION |	Used for backward compatibility with OS/2 applications (HPFS)|
|0xE0 (224) |	$EA |	Used for backward compatibility with OS/2 applications (HPFS)|
|0x100 (256) |	$LOGGED_UTILITY_STREAM |	Keys and other information about encrypted attributes (NTFS 3.0+; Windows 2000+)|


```
! When parsing the entry in MFTECmd, checking for the resident flag in $Data attribute shows if the actual data of the file are located in the record or in a cluster record on disk.

Files smaller than 512 bytes stored here and Resident flag is TRUE.


```


### Zone.Identifier

The Zone.Identifier is a specialized file metadata attribute in the Windows signifying the security zone from which a file was sourced. It's instrumental in determining how Windows processes files procured from the internet or other potentially untrusted origins.

When a file is fetched from the internet, Windows assigns it a Zone Identifier (ZoneId). This ZoneId, embedded in the file's metadata, signifies the source or security zone of the file's origin. For instance, internet-sourced files typically bear a ZoneId of 3, denoting the Internet Zone.

To unveil the content of a Zone.Identifier for a file, the following command can be executed in PowerShell.

PS C:\ >  Get-Content * -Stream Zone.Identifier -ErrorAction SilentlyContinue

One of the security mechanisms, known as the Mark of the Web (MotW), hinges on the Zone Identifier. Here, the MotW marker differentiates files sourced from the internet or other potentially dubious sources from those originating from trusted or local contexts. It's frequently employed to bolster the security of applications like Microsoft Word. When an app, say Microsoft Word, opens a file bearing a MotW, it can institute specific security measures based on the MotW's presence. For instance, a Word document with a MotW might be launched in Protected View, a restricted mode that isolates the document from the broader system, mitigating potential security threats.


### Windows Persistence Artifacts

#### Registry



- Run/RunOnce Keys

  - HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
  -    HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
  -    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
  -  HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
  -  HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies


- Keys used by WinLogon Process

  - HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon

  - HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell



- Startup Keys

  -  HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
   - HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
   - HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
   - HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User

#### Schtasks

These tasks reside in C:\Windows\System32\Tasks, with each one saved as an XML file. This file details the creator, the task's timing or trigger, and the path to the command or program set to run. 

#### Services

Services in Windows are pivotal for maintaining processes on a system, enabling software components to operate in the background without user intervention. The registry location to keep an eye on is: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services.


### Web Browser Forensics

- Browsing History
- Cookies
- Cache
- Bookmarks/Favorites
- Download History
- Autofill Data
- Search History
- Session Data
- Typed URLs
- Form Data
- Passwords
- Web Storage
- Favicons
- Tab Recovery Data
- Extensions and Add-ons


#### ShimCache 

Shimcache (also known as AppCompatCache) is a Windows mechanism used by the Windows operating systems in order to identify application compatibility issues. This database records information about executed applications, and is stored in the Windows Registry. This information can be used by developers to track compatibility issues with executed programs.

The AppCompatCache key is located at the HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\ControlSet001\Control\Session Manager\AppCompatCache registry location.

#### AmCache

AmCache refers to a Windows registry file which is used to store evidence related to program execution. It serves as a valuable resource for digital forensics and security investigations, helping analysts understand the history of application execution and detect signs of any suspicious execution.

The information that it contains include the execution path, first executed time, deleted time, and first installation. It also provides the file hash for the executables.

On Windows OS the AmCache hive is located at C:\Windows\AppCompat\Programs\AmCache.hve


#### BAM (Background Activity Moderator)



The Background Activity Moderator (BAM) is a component in the Windows operating system that tracks and logs the execution of certain types of background or scheduled tasks. BAM is actually a kernel device driver as shown in the below screenshot.

It is primarily responsible for controlling the activity of background applications but it can help us in providing the evidence of program execution which it lists under the bam registry hive. The BAM key is located at the below registry location. HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\bam\State\UserSettings\{USER-SID}

#### Captured API Call Data (.apmx64)

.apmx64 files are generated by API Monitor, which records API call data. 

#### Registry Persistence via Run Keys

An oft-employed strategy by adversaries to maintain unauthorized access to a compromised system is inserting an entry into the run keys within the Windows Registry. Let's investigate if there's any reference to the RegOpenKeyExA function, which accesses the designated registry key. To perform this search, simply type RegOpenKey into the search box, usually situated atop the API Monitor window, and press Enter.

Malicious entities often exploit this key to embed entries pointing to their backdoor, a task achievable via the registry API function RegSetValueExA.

To explore further, let's seek any mention of the RegSetValueExA function, which defines data and type for a specified value within a registry key. Engage the search box, type RegSet, and hit Enter.



### SRUM  (System Resource Usage Monitor)

SRUM meticulously tracks resource utilization and application usage patterns. The data is housed in a database file named sru.db found in the C:\Windows\System32\sru directory. This SQLite formatted database allows for structured data storage and efficient data retrieval.

Key facets of SRUM forensics encompass:

- 
    Application Profiling: SRUM can provide a comprehensive view of the applications and processes that have been executed on a Windows system. It records details such as executable names, file paths, timestamps, and resource usage metrics. This information is crucial for understanding the software landscape on a system, identifying potentially malicious or unauthorized applications, and reconstructing user activities.
-    Resource Consumption: SRUM captures data on CPU time, network usage, and memory consumption for each application and process. This data is invaluable for investigating resource-intensive activities, identifying unusual patterns of resource consumption, and detecting potential performance issues caused by specific applications.
-    Timeline Reconstruction: By analyzing SRUM data, digital forensics experts can create timelines of application and process execution, resource usage, and system activities. This timeline reconstruction is instrumental in understanding the sequence of events, identifying suspicious behaviors, and establishing a clear picture of user interactions and actions.
-    User and System Context: SRUM data includes user identifiers, which helps in attributing activities to specific users. This can aid in user behavior analysis and determining whether certain actions were performed by legitimate users or potential threat actors.
-    Malware Analysis and Detection: SRUM data can be used to identify unusual or unauthorized applications that may be indicative of malware or malicious activities. Sudden spikes in resource usage, abnormal application patterns, or unauthorized software installations can all be detected through SRUM analysis.
-    Incident Response: During incident response, SRUM can provide rapid insights into recent application and process activities, enabling analysts to quickly identify potential threats and respond effectively.


## Forensic Imaging

Forensic imaging is a fundamental process in digital forensics that involves creating an exact, bit-by-bit copy of digital storage media, such as hard drives, solid-state drives, USB drives, and memory cards.

Below are some forensic imaging tools and solutions:

- FTK Imager: FTK Imager is one of the most widely used disk imaging tools in the cybersecurity field. It allows us to create perfect copies (or images) of computer disks for analysis, preserving the integrity of the evidence. It also lets us view and analyze the contents of data storage devices without altering the data.


- AFF4 Imager: A free, open-source tool crafted for creating and duplicating forensic disk images. It's user-friendly and compatible with numerous file systems. A benefit of the AFF4 Imager is its capability to extract files based on their creation time, segment volumes, and reduce the time taken for imaging through compression.

- DD and DCFLDD: Both are command-line utilities available on Unix-based systems (including Linux and MacOS). DD is a versatile tool included in most Unix-based systems by default, while DCFLDD is an enhanced version of DD with features specifically useful for forensics, such as hashing.

- Virtualization Tools: Given the prevalent use of virtualization in modern systems, incident responders will often need to collect evidence from virtual environments. Depending on the specific virtualization solution, evidence can be gathered by temporarily halting the system and transferring the directory that houses it. Another method is to utilize the snapshot capability present in numerous virtualization software tools.

