# Iframes

## Iframe navigation and history
- when you perform navigation, the iframe’s history will also be added to the history in your browser (going back in the page will actually make the iframe go back)

```
<body>
  <iframe sandbox id=f src="data:text/html,test1:<script>alert(1)</script>"></iframe>
  <button onclick="loadTest2()">load test2</button>
  <button onclick="location = 'a.html'">top level navigation</button>
</body>
<script>
  function loadTest2() {
    f.removeAttribute('sandbox')
    f.src = 'data:text/html,test2:<script>alert(2)<\/script>'
  }
</script>
```
- First the alert(1) is blocked due to sandboxing
- Then pressing the loadTest2() , the attribute is deleted and the alert(2) gets executed.
- By pressing the navigation button , the window changes location.
- Then press back button.

Pressing back here has 2 possibilities:

### bfcache enabled
[bfcache](https://web.dev/articles/bfcache)

    ! when the main frame is restored from the bfcache, embedded iframes will be restored as they were when the page entered the bfcache

If bfcache is enabled the complete state of previous page gets rendered so the sandbox attribute is still gone and the src of iframe is test2.

### bfcache disabled

[issue](https://github.com/whatwg/html/issues/6809)

You can avoid the usage of bfcache by using the following api:

- [WebSocket](https://developer.mozilla.org/docs/Web/API/WebSocket)

- [WebTransport](https://developer.mozilla.org/docs/Web/API/WebTransport)

- [WebRTC](https://developer.mozilla.org/docs/Web/API/WebRTC_API)

There is a feature usefull for user experience that going back in an page, the browser restores the latest context of the page, but the src becomes the latest entry in the history list.

So in the context of the iframe the src will be test2 but the sandbox attribute is still present.

This is called `iframe reparenting`.

remember that when you go back:

-    The sandbox attribute always follows the latest page as it derives from HTTP-cache.
-    The src will be the last loaded webpage (as a convenience for the user).

#### Example of sanbox escaping

```
<body>
  <iframe id=f src="data:text/html,test1:<script>document.writeln(Math.random())</script>"></iframe>
  <button onclick="loadTest2()">load test2</button>
  <button onclick="location = 'a.html'">top level navigation</button>
</body>
<script>
  // to disable bfcache
  const ws = new WebSocket('ws://example.com');
  console.log('run')
  function loadTest2() {
    f.setAttribute('sandbox', '')
    f.src = 'data:text/html,test2:<script>document.writeln(Math.random())<\/script>'
  }
</script>
```

## src attribute

- The URL of the page to embed
- Can be same-origin with the parent window, or not
- Potentially sourrounded by quotation marks
- Controlled by `frame-src` in CSP Headers
- Could start with url schemes like `javascript:`, `data:` , `blob:` etc.
    - controlled by `script-src` in CSP headers instead.
- If surrounded by quotes you could encode the value:
    - `javascript:alert(1)` = `&#x6a;&#65;vAScrIpt&colon;alert&lpar;1&rpar;`
- These uri schemes (`data:`,`javascript:`) set the origin of the frame to `null`
    - So the frame canot acceess data on the page.



## srcdoc attribute

- Inline HTML to execute
- Has priority over the src attribute
- the window generated by iframe + srcdoc will inherit the origin of the upper layer
    - So it has access to elements in the upper-level window
- The iframe also inherits the CSP applied to the page
- srcdoc is not affected by the frame-src of CSP
- Can be HTML Encoded as it is wrapped in quotes.

## csp attribute 

Apart from CSP Headers and meta tags in the upper layer window , an csp attribute can be defined in the `<iframe>` tag  but not every browser supports it.

```
<iframe csp="default-src 'self'; script-src 'none';"
  srcdoc="<script>alert(1)</script>"></iframe>
```

## sandbox attribute
When specified:
- Nullifies the origin of the iframe
    - Cookies and strorage cannot be accessed
    - Can be altered with `allow-same-origin`
- flags starting with allow-top-navigation* propably allow upper layer redirection with `top.location='https://`
- Trying to xss with `alert()` or `prompt()` in srcdoc will need allow-modals to work.
- the window opened by the sandboxed iframe with `window.open()` inherits the sandbox properties

- Setting `allow-same-origin` and `allow-scripts` , allows us to execute javascript and have access to the upper layer window, and as a result to the iframe element itself.You can completely disable the sandbox property.
```
<iframe
  sandbox="allow-same-origin allow-scripts"
  srcdoc="<script>top.document.querySelector('iframe').removeAttribute('sandbox');location.reload();alert(1)</script>">
</iframe>
```
## Frame origin 

#### Same origin

if the iframe has the same origin with the top level window , its allowed access to window.top.location and redirect the window.

#### Cross-origin 

a cross-origin frame can't immediately redirect the top-level page by default.
## Reading cookies from different sites

You land on `url/siteB` and you want to read cookies set with `Path=/siteA` and `HttpOnly=false`

If you have the ability to embed an iframe you can still the cookies:

```
# url/siteB
const iframe = document.createElement('iframe')
iframe.src = 'https://example.com/siteA'
iframe.onload = () => {
  alert(iframe.contentWindow.document.cookie)
}
document.body.appendChild(iframe)
```


## Click-jacking Remediations

#### X-Frame-Options

`X-Frame-Options` response header can be used to indicate whether a browser should be allowed to render a page in a `<frame>`, `<iframe>`, `<embed>` or `<object>`.

```
X-Frame-Options: DENY (The page cannot be displayed in a frame)
X-Frame-Options: SAMEORIGIN
X-Frame-Options: ALLOW-FROM origin (Deprecated and ussually ignored) 
```

- Apache configuration

`Header  set X-Frame-Options "DENY"`

- Nginx Configuration

`add_header X-Frame-Options DENY always;`

#### CSP frame-ancestors

Specifies valid parents that may embed a page using `<frame>`, `<iframe>`, `<object>`, or `<embed>`
Setting this directive to 'none' is similar to `X-Frame-Options: deny`

```
Content-Security-Policy: frame-ancestors 'none';
Content-Security-Policy: frame-ancestors <source-expression-list>;
```


# Character Length Limits

## window.location

You could append a hash `#` to the location ,followed by the closing of quotation like ` ' or "` (depenting on the application ) , followed by a semicolon `;` , followed by xss code.

This way the window.location becomes : ` 'https://location.com/#';alert(1)`

You could embed that to the xss paylaod:
```
<svg/onload=eval(`'`+location)>
```

- We write location and **not** document.location or window.location as inline code in event handlers execute in scope of current document.

## location.hash

write your payload directly in the URL after the hash `#`
`http://example.org/#<script>alert(1)</script>`

submit the xss payload to trigger the vulnerability:
`eval(location.hash.slice(1))`


# Bypass character filters


## html attribute separators
If Space  is banned you can bypass this using these characters instead:

|Decimal value |	URL Encoded |	Human desc|
|-----------|---------------|--------------|
47 |	%2F 	|Foward slash
13 |	%0D 	|Carriage Return
12 |	%0C |	Form Feed
10 |	%0A |	New Line
9 |	%09 	|Horizontal Tab


## Parenthesis Blacklisted

you can spawn XSS with template literals:

``<img/src=x onerror=alert`1`/>``


## HTML Encoding

You can use html encoding only outside script tags as those inside it will not be decoded and sent in for javascript execution as is.

`<svg onload=alert&lpar;1&rpar;></svg>`
`<svg onload=alert&#x28;1&#x29></svg>`

[HTML Encoder](https://mothereff.in/html-entities)

## Useful tranformations

#### constructing strings

```
parseInt(“alert”,30)
8680439..toString(30) => 'alert'
```

#### Javascript escapes

```
"\x41" -> "A": hex encoding
"\u0065" -> "A": unicode encoding (value is decimal)
"\101" -> "A": octal encoding
```


## Mysql encodings

- Mysql based applications listening in web for input and passing the strings to queries , could also include [Hexadecimal literals](https://dev.mysql.com/doc/refman/9.1/en/hexadecimal-literals.html)
- Inject strings like 0x27 ("'") or X'27' to bypass filters.
- programming languages, like python, still interpet the strings as normal ascii text ,e.g. `SELECT id, username FROM users WHERE username = ('/') AND password = (') UNION SELECT 1,0x27` , but executing the sql query on the backend , the 0x27 is acting as `'`.

# Event Handlers in HTML tags and theyre usage


|Tag Attribute |	Tags supported 	|Note|
|-------|----------|------------|
onload| 	body, iframe, img, frameset, input, script, style, link, svg 	|Great for 0-click, but super commonly filtered
onpageshow |	body 	|Great for 0-click, but appears only usable in Non-DOM injections
onfocus |	input, select, a 	|for 0-click: use together with autofocus=""
onerror |	img, input, object, link, script, video, audio |	make sure to pass params to make it fail
onanimationstart |	Combine with any element that can be animated 	|Fired then a CSS animation starts
onanimationend |	Combine with any element that can be animated 	|Fires when a CSS animation ends
onstart |	marquee 	|Fires on marquee animation start - Firefox only?
onfinish |	marquee 	|Fires on marquee animation end - Firefox only?
ontoggle |	details 	|Must have the ‘open’ attribute for 0-click
onmessage |	most tags |	postMessage is commonly used to get around iframe restrictions and share data, as a result if your page is doing this you can use onmessage to intercept messages and trigger code
onblur 	|input, select, a 	|Set autofocus="" for an easy 1-click when the user switches focus away from the injected element by clicking on anything on the page



# JSON


## Json duplicate keys

- Some json parsers act differently when it comes to parsing duplicate keys in a json input
- A json library might prefer keep the first occurence, the last occurence, merge all occurences in a set , or just throw an error.
- We could exploit this behaviour in apps using more than one parsers in different componets and subvert application logic

## Json unicode character truncation

- Some json parsers truncate some "illegal" unicode completely, while other leave intact as a string
- Example unicode chars are `\ud800` and `\ud888`

## Json Comments

- Some json libraries support quotless string (keys and values) and also comment text with the use of `/* */`
- An attacker could smuggle duplicate keys if the two lirbaries parsing the string both support quotless strings but dont support comments.

`{"test": 1 ,comm1: /*,"test": 2, comm2: */}`
` {"test": 1 ,comm1:"a"/*,"test": 2, comm2:"b"*/}`



# Javascript


## Web API

#### new URL(url,base) constructor

- Passing a single `/` after the scheme has [strange](https://vitorfalcao.com/posts/intigriti-0525-writeup/#checks-vs-usage-a-subtle-difference) results

- `https:@domain/yourscript.js` can also be used

```javascript
//  assuming location.origin is 'https://server.com'
(new URL('https:/attacker.com/hacky.js', location)).origin
// expected: 'https://server.com'

// not specifying {base} parameter
(new URL('https:/attacker.com/hacky.js')).origin
// expected: 'https://attacker.com'
```

